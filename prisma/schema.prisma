generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// =============================================
// CAP MANAGER - Schema do Banco de Dados
// =============================================

model Usuario {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  senha     String
  nome      String
  avatarUrl String?  @map("avatar_url")
  role      Role     @default(trader)
  whatsapp  String?
  ativo     Boolean  @default(true)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relações
  projetosComoTrader Projeto[]   @relation("TraderProjetos")
  tarefas            Tarefa[]    @relation("ResponsavelTarefas")
  followUps          FollowUp[]
  alertas            Alerta[]

  @@map("usuarios")
}

enum Role {
  admin
  trader
  gestor
  cliente
}

model Agencia {
  id          Int      @id @default(autoincrement())
  nome        String
  porcentagem Decimal  @default(0) @db.Decimal(5, 2)
  local       String
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relações
  clientes Cliente[]
  projetos Projeto[]

  @@map("agencias")
}

model Cliente {
  id             Int            @id @default(autoincrement())
  nome           String
  agenciaId      Int?           @map("agencia_id")
  linkDrive      String?        @map("link_drive")
  contato        String
  cnpj           String?
  email          String
  diaCobranca    Int            @default(1) @map("dia_cobranca")
  formaPagamento FormaPagamento @default(pix) @map("forma_pagamento")
  whatsapp       String?
  ativo          Boolean        @default(true)
  createdAt      DateTime       @default(now()) @map("created_at")
  updatedAt      DateTime       @updatedAt @map("updated_at")

  // Relações
  agencia  Agencia?  @relation(fields: [agenciaId], references: [id], onDelete: SetNull)
  projetos Projeto[]
  tarefas  Tarefa[]

  @@map("clientes")
}

enum FormaPagamento {
  pix
  boleto
  cartao
  transferencia
}

// Projeto = antiga Campanha (container principal)
model Projeto {
  id             Int            @id @default(autoincrement())
  clienteId      Int            @map("cliente_id")
  nome           String
  piId           Int?           @map("pi_id")
  tipoCobranca   TipoCobranca   @default(td) @map("tipo_cobranca")
  agenciaId      Int?           @map("agencia_id")
  traderId       Int?           @map("trader_id")
  status         StatusProjeto  @default(rascunho)
  dataInicio     DateTime?      @map("data_inicio") @db.Date
  dataFim        DateTime?      @map("data_fim") @db.Date
  linkProposta   String?        @map("link_proposta")
  praca          String?
  publico        String?
  urlDestino     String?        @map("url_destino") @db.Text
  createdAt      DateTime       @default(now()) @map("created_at")
  updatedAt      DateTime       @updatedAt @map("updated_at")

  // Relações
  cliente     Cliente      @relation(fields: [clienteId], references: [id], onDelete: Cascade)
  trader      Usuario?     @relation("TraderProjetos", fields: [traderId], references: [id], onDelete: SetNull)
  pi          Pi?          @relation(fields: [piId], references: [id], onDelete: SetNull)
  agencia     Agencia?     @relation(fields: [agenciaId], references: [id], onDelete: SetNull)
  estrategias Estrategia[]
  tarefas     Tarefa[]
  followUps   FollowUp[]
  utmConfigs  UtmConfig[]

  @@map("projetos")
}

// Estrategia = linha de midia dentro de um Projeto
model Estrategia {
  id                    Int              @id @default(autoincrement())
  projetoId             Int              @map("projeto_id")
  plataforma            Plataforma
  nomeConta             String?          @map("nome_conta")
  idConta               String?          @map("id_conta")
  estrategia            String?          // Descricao da estrategia
  kpi                   String?
  status                StatusEstrategia @default(planejada)
  valorBruto            Decimal          @default(0) @map("valor_bruto") @db.Decimal(12, 2)
  porcentagemAgencia    Decimal          @default(0) @map("porcentagem_agencia") @db.Decimal(5, 2)
  porcentagemPlataforma Decimal          @default(0) @map("porcentagem_plataforma") @db.Decimal(5, 2)
  entregaContratada     Decimal?         @map("entrega_contratada") @db.Decimal(12, 2)
  gastoAteMomento       Decimal?         @map("gasto_ate_momento") @db.Decimal(12, 2)
  entregueAteMomento    Decimal?         @map("entregue_ate_momento") @db.Decimal(12, 2)
  dataAtualizacao       DateTime?        @map("data_atualizacao")
  createdAt             DateTime         @default(now()) @map("created_at")
  updatedAt             DateTime         @updatedAt @map("updated_at")

  // Relações
  projeto Projeto @relation(fields: [projetoId], references: [id], onDelete: Cascade)

  @@map("estrategias")
}

enum TipoCobranca {
  td
  fee
}

enum Plataforma {
  meta
  google
  tiktok
  linkedin
  twitter
  pinterest
  spotify
  programatica
  outro
}

enum StatusProjeto {
  rascunho
  ativo
  pausado
  finalizado
  cancelado
}

enum StatusEstrategia {
  planejada
  ativa
  pausada
  finalizada
  cancelada
}

model Tarefa {
  id             Int              @id @default(autoincrement())
  titulo         String
  descricao      String?          @db.Text
  status         StatusTarefa     @default(backlog)
  prioridade     PrioridadeTarefa @default(media)
  projetoId      Int?             @map("projeto_id")
  clienteId      Int?             @map("cliente_id")
  responsavelId  Int?             @map("responsavel_id")
  dataVencimento DateTime?        @map("data_vencimento") @db.Date
  ordem          Int              @default(0)
  createdAt      DateTime         @default(now()) @map("created_at")
  updatedAt      DateTime         @updatedAt @map("updated_at")

  // Relações
  projeto     Projeto?  @relation(fields: [projetoId], references: [id], onDelete: SetNull)
  cliente     Cliente?  @relation(fields: [clienteId], references: [id], onDelete: SetNull)
  responsavel Usuario?  @relation("ResponsavelTarefas", fields: [responsavelId], references: [id], onDelete: SetNull)

  @@map("tarefas")
}

enum StatusTarefa {
  backlog
  todo
  doing
  review
  done
}

enum PrioridadeTarefa {
  baixa
  media
  alta
  urgente
}

model FollowUp {
  id        Int          @id @default(autoincrement())
  projetoId Int          @map("projeto_id")
  traderId  Int          @map("trader_id")
  conteudo  String       @db.Text
  tipo      TipoFollowUp @default(nota)
  createdAt DateTime     @default(now()) @map("created_at")

  // Relações
  projeto Projeto @relation(fields: [projetoId], references: [id], onDelete: Cascade)
  trader  Usuario @relation(fields: [traderId], references: [id], onDelete: Cascade)

  @@map("follow_ups")
}

enum TipoFollowUp {
  nota
  alerta
  atualizacao
  reuniao
}

model UtmConfig {
  id          Int      @id @default(autoincrement())
  projetoId   Int?     @map("projeto_id")
  utmSource   String   @map("utm_source")
  utmMedium   String   @map("utm_medium")
  utmCampaign String   @map("utm_campaign")
  utmTerm     String?  @map("utm_term")
  utmContent  String?  @map("utm_content")
  urlDestino  String   @map("url_destino")
  urlGerada   String   @map("url_gerada") @db.Text
  createdAt   DateTime @default(now()) @map("created_at")

  // Relações
  projeto Projeto? @relation(fields: [projetoId], references: [id], onDelete: Cascade)

  @@map("utm_configs")
}

model Alerta {
  id                Int         @id @default(autoincrement())
  tipo              TipoAlerta
  titulo            String
  mensagem          String      @db.Text
  destinatarioId    Int         @map("destinatario_id")
  lido              Boolean     @default(false)
  enviadoWhatsapp   Boolean     @default(false) @map("enviado_whatsapp")
  dataEnvioWhatsapp DateTime?   @map("data_envio_whatsapp")
  createdAt         DateTime    @default(now()) @map("created_at")

  // Relações
  destinatario Usuario @relation(fields: [destinatarioId], references: [id], onDelete: Cascade)

  @@map("alertas")
}

enum TipoAlerta {
  cobranca
  campanha
  tarefa
  sistema
}

model Pi {
  id            Int      @id @default(autoincrement())
  identificador String   @unique
  valorBruto    Decimal  @map("valor_bruto") @db.Decimal(12, 2)
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relações
  projetos Projeto[]

  @@map("pis")
}
