generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["multiSchema"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["cap_manager"]
}

// =============================================
// CAP MANAGER - Schema do Banco de Dados
// =============================================

model Usuario {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  senha     String
  nome      String
  avatarUrl String?  @map("avatar_url")
  role      Role     @default(trader)
  whatsapp  String?
  ativo     Boolean  @default(true)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relações
  projetosComoTrader      Projeto[]       @relation("TraderProjetos")
  projetosComoColaborador Projeto[]       @relation("ColaboradorProjetos")
  tarefas                 Tarefa[]        @relation("ResponsavelTarefas")
  followUps               FollowUp[]
  alertas                 Alerta[]
  revisoesDiarias         RevisaoDiaria[] @relation("RevisoesDiarias")

  @@index([role])
  @@index([ativo])
  @@map("usuarios")
  @@schema("cap_manager")
}

enum Role {
  admin
  trader
  gestor
  cliente

  @@schema("cap_manager")
}

model Agencia {
  id        Int      @id @default(autoincrement())
  nome      String
  cnpj      String?
  telefone  String?
  email     String?
  contato   String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relações
  clientes Cliente[]
  projetos Projeto[]
  pis      Pi[]

  @@map("agencias")
  @@schema("cap_manager")
}

model Cliente {
  id           Int          @id @default(autoincrement())
  nome         String
  agenciaId    Int?         @map("agencia_id")
  contato      String?
  cnpj         String?
  email        String?
  whatsapp     String?
  tipoCobranca TipoCobranca @default(td) @map("tipo_cobranca")
  ativo        Boolean      @default(true)
  createdAt    DateTime     @default(now()) @map("created_at")
  updatedAt    DateTime     @updatedAt @map("updated_at")

  // Relações
  agencia  Agencia?  @relation(fields: [agenciaId], references: [id], onDelete: SetNull)
  projetos Projeto[]
  tarefas  Tarefa[]
  pis      Pi[]

  @@index([ativo])
  @@index([agenciaId])
  @@map("clientes")
  @@schema("cap_manager")
}

model Projeto {
  id             Int            @id @default(autoincrement())
  clienteId      Int            @map("cliente_id")
  nome           String
  piId           Int?           @map("pi_id")
  tipoCobranca   TipoCobranca   @default(td) @map("tipo_cobranca")
  agenciaId      Int?           @map("agencia_id")
  traderId       Int?           @map("trader_id")
  colaboradorId  Int?           @map("colaborador_id")
  status         StatusProjeto  @default(rascunho)
  dataInicio     DateTime?      @map("data_inicio") @db.Date
  dataFim        DateTime?      @map("data_fim") @db.Date
  linkProposta   String?        @map("link_proposta")
  urlDestino     String?        @map("url_destino") @db.Text
  grupoRevisao   GrupoRevisao?  @map("grupo_revisao")
  revisaoFinalOk       Boolean   @default(false) @map("revisao_final_ok")
  revisaoFinalData     DateTime? @map("revisao_final_data")
  revisaoFinalUsuarioId Int?     @map("revisao_final_usuario_id")
  createdAt      DateTime       @default(now()) @map("created_at")
  updatedAt      DateTime       @updatedAt @map("updated_at")

  // Relações
  cliente       Cliente            @relation(fields: [clienteId], references: [id], onDelete: Cascade)
  trader        Usuario?           @relation("TraderProjetos", fields: [traderId], references: [id], onDelete: SetNull)
  colaborador   Usuario?           @relation("ColaboradorProjetos", fields: [colaboradorId], references: [id], onDelete: SetNull)
  pi            Pi?                @relation(fields: [piId], references: [id], onDelete: SetNull)
  agencia       Agencia?           @relation(fields: [agenciaId], references: [id], onDelete: SetNull)
  estrategias   Estrategia[]
  tarefas       Tarefa[]
  followUps     FollowUp[]
  utmConfigs    UtmConfig[]
  revisoesDiarias RevisaoDiaria[]

  @@index([status])
  @@index([clienteId])
  @@index([traderId])
  @@index([status, clienteId])
  @@index([grupoRevisao])
  @@map("projetos")
  @@schema("cap_manager")
}

enum GrupoRevisao {
  A
  B
  C

  @@schema("cap_manager")
}

model Estrategia {
  id                    Int              @id @default(autoincrement())
  projetoId             Int              @map("projeto_id")
  plataforma            Plataforma
  nomeConta             String?          @map("nome_conta")
  idConta               String?          @map("id_conta")
  campaignId            String?          @map("campaign_id")
  estrategia            String?
  kpi                   String?
  status                StatusEstrategia @default(planejada)
  dataInicio            DateTime?        @map("data_inicio") @db.Date

  valorBruto            Decimal          @default(0) @map("valor_bruto") @db.Decimal(12, 2)
  porcentagemAgencia    Decimal          @default(0) @map("porcentagem_agencia") @db.Decimal(5, 2)
  porcentagemPlataforma Decimal          @default(0) @map("porcentagem_plataforma") @db.Decimal(5, 2)

  valorLiquido          Decimal?         @map("valor_liquido") @db.Decimal(12, 2)
  valorPlataforma       Decimal?         @map("valor_plataforma") @db.Decimal(12, 2)
  coeficiente           Decimal?         @map("coeficiente") @db.Decimal(8, 6)
  valorPorDiaPlataforma Decimal?         @map("valor_por_dia_plataforma") @db.Decimal(12, 2)
  valorRestante         Decimal?         @map("valor_restante") @db.Decimal(12, 2)
  restantePorDia        Decimal?         @map("restante_por_dia") @db.Decimal(12, 2)

  entregaContratada     Decimal?         @map("entrega_contratada") @db.Decimal(12, 2)
  percentualEntrega     Decimal?         @map("percentual_entrega") @db.Decimal(8, 4)
  estimativaResultado   Decimal?         @map("estimativa_resultado") @db.Decimal(12, 2)
  estimativaSucesso     Decimal?         @map("estimativa_sucesso") @db.Decimal(8, 4)

  metaCustoResultado    Decimal?         @map("meta_custo_resultado") @db.Decimal(12, 2)
  custoResultado        Decimal?         @map("custo_resultado") @db.Decimal(12, 2)

  gastoAteMomentoBruto  Decimal?         @map("gasto_ate_momento_bruto") @db.Decimal(12, 2)
  valorRestanteBruto    Decimal?         @map("valor_restante_bruto") @db.Decimal(12, 2)

  podeAbaixarMargem     Boolean?         @map("pode_abaixar_margem")
  podeAumentarMargem    Boolean?         @map("pode_aumentar_margem")

  gastoAteMomento       Decimal?         @map("gasto_ate_momento") @db.Decimal(12, 2)
  entregueAteMomento    Decimal?         @map("entregue_ate_momento") @db.Decimal(12, 2)
  dataAtualizacao       DateTime?        @map("data_atualizacao")

  createdAt             DateTime         @default(now()) @map("created_at")
  updatedAt             DateTime         @updatedAt @map("updated_at")

  projeto Projeto @relation(fields: [projetoId], references: [id], onDelete: Cascade)

  @@map("estrategias")
  @@schema("cap_manager")
}

enum TipoCobranca {
  td
  fee

  @@schema("cap_manager")
}

enum Plataforma {
  meta
  google
  tiktok
  linkedin
  twitter
  pinterest
  spotify
  programatica
  outro

  @@schema("cap_manager")
}

enum StatusProjeto {
  rascunho
  ativo
  pausado
  finalizado
  cancelado

  @@schema("cap_manager")
}

enum StatusEstrategia {
  planejada
  ativa
  pausada
  finalizada
  cancelada

  @@schema("cap_manager")
}

model Tarefa {
  id             Int              @id @default(autoincrement())
  titulo         String
  descricao      String?          @db.Text
  status         StatusTarefa     @default(backlog)
  prioridade     PrioridadeTarefa @default(media)
  projetoId      Int?             @map("projeto_id")
  clienteId      Int?             @map("cliente_id")
  responsavelId  Int?             @map("responsavel_id")
  dataVencimento DateTime?        @map("data_vencimento") @db.Date
  ordem          Int              @default(0)
  createdAt      DateTime         @default(now()) @map("created_at")
  updatedAt      DateTime         @updatedAt @map("updated_at")

  projeto     Projeto?  @relation(fields: [projetoId], references: [id], onDelete: SetNull)
  cliente     Cliente?  @relation(fields: [clienteId], references: [id], onDelete: SetNull)
  responsavel Usuario?  @relation("ResponsavelTarefas", fields: [responsavelId], references: [id], onDelete: SetNull)

  @@index([status])
  @@index([responsavelId])
  @@index([status, ordem])
  @@map("tarefas")
  @@schema("cap_manager")
}

enum StatusTarefa {
  backlog
  todo
  doing
  review
  done

  @@schema("cap_manager")
}

enum PrioridadeTarefa {
  baixa
  media
  alta
  urgente

  @@schema("cap_manager")
}

model FollowUp {
  id        Int          @id @default(autoincrement())
  projetoId Int          @map("projeto_id")
  traderId  Int          @map("trader_id")
  conteudo  String       @db.Text
  tipo      TipoFollowUp @default(nota)
  createdAt DateTime     @default(now()) @map("created_at")

  projeto Projeto @relation(fields: [projetoId], references: [id], onDelete: Cascade)
  trader  Usuario @relation(fields: [traderId], references: [id], onDelete: Cascade)

  @@map("follow_ups")
  @@schema("cap_manager")
}

enum TipoFollowUp {
  nota
  alerta
  atualizacao
  reuniao

  @@schema("cap_manager")
}

model RevisaoDiaria {
  id              Int       @id @default(autoincrement())
  projetoId       Int       @map("projeto_id")
  dataAgendada    DateTime  @map("data_agendada") @db.Date
  revisado        Boolean   @default(false)
  dataRevisao     DateTime? @map("data_revisao")
  revisadoPorId   Int?      @map("revisado_por_id")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  projeto     Projeto  @relation(fields: [projetoId], references: [id], onDelete: Cascade)
  revisadoPor Usuario? @relation("RevisoesDiarias", fields: [revisadoPorId], references: [id], onDelete: SetNull)

  @@unique([projetoId, dataAgendada])
  @@index([dataAgendada])
  @@index([revisado])
  @@map("revisoes_diarias")
  @@schema("cap_manager")
}

model UtmConfig {
  id          Int      @id @default(autoincrement())
  projetoId   Int?     @map("projeto_id")
  utmSource   String   @map("utm_source")
  utmMedium   String   @map("utm_medium")
  utmCampaign String   @map("utm_campaign")
  utmTerm     String?  @map("utm_term")
  utmContent  String?  @map("utm_content")
  urlDestino  String   @map("url_destino")
  urlGerada   String   @map("url_gerada") @db.Text
  createdAt   DateTime @default(now()) @map("created_at")

  projeto Projeto? @relation(fields: [projetoId], references: [id], onDelete: Cascade)

  @@map("utm_configs")
  @@schema("cap_manager")
}

model Alerta {
  id                Int         @id @default(autoincrement())
  tipo              TipoAlerta
  titulo            String
  mensagem          String      @db.Text
  destinatarioId    Int         @map("destinatario_id")
  lido              Boolean     @default(false)
  enviadoWhatsapp   Boolean     @default(false) @map("enviado_whatsapp")
  dataEnvioWhatsapp DateTime?   @map("data_envio_whatsapp")
  createdAt         DateTime    @default(now()) @map("created_at")

  destinatario Usuario @relation(fields: [destinatarioId], references: [id], onDelete: Cascade)

  @@map("alertas")
  @@schema("cap_manager")
}

enum TipoAlerta {
  cobranca
  campanha
  tarefa
  sistema

  @@schema("cap_manager")
}

model Pi {
  id            Int      @id @default(autoincrement())
  identificador String   @unique
  valorBruto    Decimal  @map("valor_bruto") @db.Decimal(12, 2)
  agenciaId     Int?     @map("agencia_id")
  clienteId     Int?     @map("cliente_id")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  agencia  Agencia?  @relation(fields: [agenciaId], references: [id], onDelete: SetNull)
  cliente  Cliente?  @relation(fields: [clienteId], references: [id], onDelete: SetNull)
  projetos Projeto[]

  @@map("pis")
  @@schema("cap_manager")
}

model CardKanban {
  id                    Int              @id @default(autoincrement())
  titulo                String
  descricao             String?          @db.Text
  area                  AreaKanban
  status                String           @default("backlog")
  prioridade            PrioridadeTarefa @default(media)
  clienteId             Int?             @map("cliente_id")
  projetoId             Int?             @map("projeto_id")
  traderId              Int?             @map("trader_id")
  responsavelRelatorioId Int?            @map("responsavel_relatorio_id")
  responsavelRevisaoId  Int?             @map("responsavel_revisao_id")
  revisaoRelatorioOk    Boolean          @default(false) @map("revisao_relatorio_ok")
  linkRelatorio         String?          @map("link_relatorio")
  faturamentoCardId     Int?             @map("faturamento_card_id")
  dataVencimento        DateTime?        @map("data_vencimento") @db.Date
  ordem                 Int              @default(0)
  createdAt             DateTime         @default(now()) @map("created_at")
  updatedAt             DateTime         @updatedAt @map("updated_at")

  @@map("cards_kanban")
  @@schema("cap_manager")
}

enum AreaKanban {
  gestao_trafego
  faturamento
  dashboards
  gtm
  sites_lp
  projetos_concluidos

  @@schema("cap_manager")
}
