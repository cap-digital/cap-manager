generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// =============================================
// CAP MANAGER - Schema do Banco de Dados
// =============================================

model Usuario {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  senha     String
  nome      String
  avatarUrl String?  @map("avatar_url")
  role      Role     @default(trader)
  whatsapp  String?
  ativo     Boolean  @default(true)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relações
  projetosComoTrader      Projeto[]       @relation("TraderProjetos")
  projetosComoColaborador Projeto[]       @relation("ColaboradorProjetos")
  tarefas                 Tarefa[]        @relation("ResponsavelTarefas")
  followUps               FollowUp[]
  alertas                 Alerta[]
  revisoesDiarias         RevisaoDiaria[] @relation("RevisoesDiarias")

  @@index([role])
  @@index([ativo])
  @@map("usuarios")
}

enum Role {
  admin
  trader
  gestor
  cliente
}

model Agencia {
  id        Int      @id @default(autoincrement())
  nome      String
  cnpj      String?
  telefone  String?
  email     String?
  contato   String?  // Nome do contato (opcional)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relações
  clientes Cliente[]
  projetos Projeto[]
  pis      Pi[]

  @@map("agencias")
}

model Cliente {
  id           Int          @id @default(autoincrement())
  nome         String
  agenciaId    Int?         @map("agencia_id")
  contato      String?
  cnpj         String?
  email        String?
  whatsapp     String?
  tipoCobranca TipoCobranca @default(td) @map("tipo_cobranca")
  ativo        Boolean      @default(true)
  createdAt    DateTime     @default(now()) @map("created_at")
  updatedAt    DateTime     @updatedAt @map("updated_at")

  // Relações
  agencia  Agencia?  @relation(fields: [agenciaId], references: [id], onDelete: SetNull)
  projetos Projeto[]
  tarefas  Tarefa[]
  pis      Pi[]

  @@index([ativo])
  @@index([agenciaId])
  @@map("clientes")
}

// Projeto = antiga Campanha (container principal)
model Projeto {
  id             Int            @id @default(autoincrement())
  clienteId      Int            @map("cliente_id")
  nome           String
  piId           Int?           @map("pi_id") // Só para projetos TD
  tipoCobranca   TipoCobranca   @default(td) @map("tipo_cobranca")
  agenciaId      Int?           @map("agencia_id") // Só para projetos TD
  traderId       Int?           @map("trader_id") // Responsável principal
  colaboradorId  Int?           @map("colaborador_id") // Colaborador do projeto
  status         StatusProjeto  @default(rascunho)
  dataInicio     DateTime?      @map("data_inicio") @db.Date
  dataFim        DateTime?      @map("data_fim") @db.Date
  linkProposta   String?        @map("link_proposta")
  urlDestino     String?        @map("url_destino") @db.Text
  // Grupo de revisão para follow-ups
  grupoRevisao   GrupoRevisao?  @map("grupo_revisao")
  // Campos de revisão final (ativo quando data_fim = hoje + 1 dia)
  revisaoFinalOk       Boolean   @default(false) @map("revisao_final_ok")
  revisaoFinalData     DateTime? @map("revisao_final_data")
  revisaoFinalUsuarioId Int?     @map("revisao_final_usuario_id")
  createdAt      DateTime       @default(now()) @map("created_at")
  updatedAt      DateTime       @updatedAt @map("updated_at")

  // Relações
  cliente       Cliente            @relation(fields: [clienteId], references: [id], onDelete: Cascade)
  trader        Usuario?           @relation("TraderProjetos", fields: [traderId], references: [id], onDelete: SetNull)
  colaborador   Usuario?           @relation("ColaboradorProjetos", fields: [colaboradorId], references: [id], onDelete: SetNull)
  pi            Pi?                @relation(fields: [piId], references: [id], onDelete: SetNull)
  agencia       Agencia?           @relation(fields: [agenciaId], references: [id], onDelete: SetNull)
  estrategias   Estrategia[]
  tarefas       Tarefa[]
  followUps     FollowUp[]
  utmConfigs    UtmConfig[]
  revisoesDiarias RevisaoDiaria[]

  @@index([status])
  @@index([clienteId])
  @@index([traderId])
  @@index([status, clienteId])
  @@index([grupoRevisao])
  @@map("projetos")
}

// Grupos de Revisão para Follow-ups
enum GrupoRevisao {
  A  // Todos os dias
  B  // Segunda, Quarta, Sexta
  C  // Terça, Quinta
}

// Estrategia = linha de midia dentro de um Projeto
model Estrategia {
  id                    Int              @id @default(autoincrement())
  projetoId             Int              @map("projeto_id")
  plataforma            Plataforma
  nomeConta             String?          @map("nome_conta")
  idConta               String?          @map("id_conta")
  campaignId            String?          @map("campaign_id") // Obrigatorio antes de criar nova estrategia
  estrategia            String?          // Descricao da estrategia
  kpi                   String?
  status                StatusEstrategia @default(planejada)

  // Valores financeiros
  valorBruto            Decimal          @default(0) @map("valor_bruto") @db.Decimal(12, 2)
  porcentagemAgencia    Decimal          @default(0) @map("porcentagem_agencia") @db.Decimal(5, 2) // % Agencia fixa por estrategia
  porcentagemPlataforma Decimal          @default(0) @map("porcentagem_plataforma") @db.Decimal(5, 2) // % Plataforma variavel
  // Campos calculados no frontend:
  // valorLiquido = valorBruto - (valorBruto * porcentagemAgencia / 100)
  // valorPlataforma = valorLiquido * porcentagemPlataforma / 100
  // valorPorDiaPlataforma = valorPlataforma / diasTotaisProjeto
  // valorRestante = valorPlataforma - gastoAteMomento

  // Estimativas
  entregaContratada     Decimal?         @map("entrega_contratada") @db.Decimal(12, 2)
  estimativaResultado   Decimal?         @map("estimativa_resultado") @db.Decimal(12, 2)
  estimativaSucesso     Decimal?         @map("estimativa_sucesso") @db.Decimal(5, 2) // % estimativa de sucesso

  // Acompanhamento em destaque para o trader
  gastoAteMomento       Decimal?         @map("gasto_ate_momento") @db.Decimal(12, 2)
  entregueAteMomento    Decimal?         @map("entregue_ate_momento") @db.Decimal(12, 2)
  dataAtualizacao       DateTime?        @map("data_atualizacao")

  createdAt             DateTime         @default(now()) @map("created_at")
  updatedAt             DateTime         @updatedAt @map("updated_at")

  // Relacoes
  projeto Projeto @relation(fields: [projetoId], references: [id], onDelete: Cascade)

  @@map("estrategias")
}

enum TipoCobranca {
  td
  fee
}

enum Plataforma {
  meta
  google
  tiktok
  linkedin
  twitter
  pinterest
  spotify
  programatica
  outro
}

enum StatusProjeto {
  rascunho
  ativo
  pausado
  finalizado
  cancelado
}

enum StatusEstrategia {
  planejada
  ativa
  pausada
  finalizada
  cancelada
}

model Tarefa {
  id             Int              @id @default(autoincrement())
  titulo         String
  descricao      String?          @db.Text
  status         StatusTarefa     @default(backlog)
  prioridade     PrioridadeTarefa @default(media)
  projetoId      Int?             @map("projeto_id")
  clienteId      Int?             @map("cliente_id")
  responsavelId  Int?             @map("responsavel_id")
  dataVencimento DateTime?        @map("data_vencimento") @db.Date
  ordem          Int              @default(0)
  createdAt      DateTime         @default(now()) @map("created_at")
  updatedAt      DateTime         @updatedAt @map("updated_at")

  // Relações
  projeto     Projeto?  @relation(fields: [projetoId], references: [id], onDelete: SetNull)
  cliente     Cliente?  @relation(fields: [clienteId], references: [id], onDelete: SetNull)
  responsavel Usuario?  @relation("ResponsavelTarefas", fields: [responsavelId], references: [id], onDelete: SetNull)

  @@index([status])
  @@index([responsavelId])
  @@index([status, ordem])
  @@map("tarefas")
}

enum StatusTarefa {
  backlog
  todo
  doing
  review
  done
}

enum PrioridadeTarefa {
  baixa
  media
  alta
  urgente
}

model FollowUp {
  id        Int          @id @default(autoincrement())
  projetoId Int          @map("projeto_id")
  traderId  Int          @map("trader_id")
  conteudo  String       @db.Text
  tipo      TipoFollowUp @default(nota)
  createdAt DateTime     @default(now()) @map("created_at")

  // Relações
  projeto Projeto @relation(fields: [projetoId], references: [id], onDelete: Cascade)
  trader  Usuario @relation(fields: [traderId], references: [id], onDelete: Cascade)

  @@map("follow_ups")
}

enum TipoFollowUp {
  nota
  alerta
  atualizacao
  reuniao
}

// Revisão Diária - rastreia se o projeto foi revisado em cada dia agendado
model RevisaoDiaria {
  id              Int       @id @default(autoincrement())
  projetoId       Int       @map("projeto_id")
  dataAgendada    DateTime  @map("data_agendada") @db.Date
  revisado        Boolean   @default(false)
  dataRevisao     DateTime? @map("data_revisao")
  revisadoPorId   Int?      @map("revisado_por_id")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relações
  projeto     Projeto  @relation(fields: [projetoId], references: [id], onDelete: Cascade)
  revisadoPor Usuario? @relation("RevisoesDiarias", fields: [revisadoPorId], references: [id], onDelete: SetNull)

  @@unique([projetoId, dataAgendada])
  @@index([dataAgendada])
  @@index([revisado])
  @@map("revisoes_diarias")
}

model UtmConfig {
  id          Int      @id @default(autoincrement())
  projetoId   Int?     @map("projeto_id")
  utmSource   String   @map("utm_source")
  utmMedium   String   @map("utm_medium")
  utmCampaign String   @map("utm_campaign")
  utmTerm     String?  @map("utm_term")
  utmContent  String?  @map("utm_content")
  urlDestino  String   @map("url_destino")
  urlGerada   String   @map("url_gerada") @db.Text
  createdAt   DateTime @default(now()) @map("created_at")

  // Relações
  projeto Projeto? @relation(fields: [projetoId], references: [id], onDelete: Cascade)

  @@map("utm_configs")
}

model Alerta {
  id                Int         @id @default(autoincrement())
  tipo              TipoAlerta
  titulo            String
  mensagem          String      @db.Text
  destinatarioId    Int         @map("destinatario_id")
  lido              Boolean     @default(false)
  enviadoWhatsapp   Boolean     @default(false) @map("enviado_whatsapp")
  dataEnvioWhatsapp DateTime?   @map("data_envio_whatsapp")
  createdAt         DateTime    @default(now()) @map("created_at")

  // Relações
  destinatario Usuario @relation(fields: [destinatarioId], references: [id], onDelete: Cascade)

  @@map("alertas")
}

enum TipoAlerta {
  cobranca
  campanha
  tarefa
  sistema
}

model Pi {
  id            Int      @id @default(autoincrement())
  identificador String   @unique
  valorBruto    Decimal  @map("valor_bruto") @db.Decimal(12, 2)
  agenciaId     Int?     @map("agencia_id")
  clienteId     Int?     @map("cliente_id")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relações
  agencia  Agencia?  @relation(fields: [agenciaId], references: [id], onDelete: SetNull)
  cliente  Cliente?  @relation(fields: [clienteId], references: [id], onDelete: SetNull)
  projetos Projeto[]

  @@map("pis")
}

// =============================================
// GESTÃO DE PROJETOS - KANBAN
// =============================================

// Card do Kanban para as áreas de Gestão de Projetos
model CardKanban {
  id                    Int              @id @default(autoincrement())
  titulo                String
  descricao             String?          @db.Text
  area                  AreaKanban       // Qual área do sistema (gestao_trafego, faturamento, etc)
  status                String           @default("backlog") // Status dinâmico por área
  prioridade            PrioridadeTarefa @default(media)
  clienteId             Int?             @map("cliente_id")
  projetoId             Int?             @map("projeto_id")
  traderId              Int?             @map("trader_id") // Trader responsável
  responsavelRelatorioId Int?            @map("responsavel_relatorio_id") // Quem faz o relatório
  responsavelRevisaoId  Int?             @map("responsavel_revisao_id") // Quem revisa o relatório
  revisaoRelatorioOk    Boolean          @default(false) @map("revisao_relatorio_ok") // Check da revisão
  linkRelatorio         String?          @map("link_relatorio") // Link do relatório final
  faturamentoCardId     Int?             @map("faturamento_card_id") // ID do card de faturamento relacionado (para projetos concluídos)
  dataVencimento        DateTime?        @map("data_vencimento") @db.Date
  ordem                 Int              @default(0)
  createdAt             DateTime         @default(now()) @map("created_at")
  updatedAt             DateTime         @updatedAt @map("updated_at")

  @@map("cards_kanban")
}

// Áreas do Kanban
enum AreaKanban {
  gestao_trafego
  faturamento
  dashboards
  gtm
  sites_lp
  projetos_concluidos
}

// Status para Gestão de Tráfego (fluxo completo):
// backlog -> para_fazer -> em_execucao -> projeto_finalizado ->
// relatorio_a_fazer -> relatorio_em_revisao -> relatorio_finalizado -> (vai para faturamento + projetos_concluidos)

// Status para Inteligência (dashboards, gtm, sites_lp):
// backlog -> para_fazer -> em_execucao -> finalizado

// Status para Faturamento:
// backlog -> para_fazer -> em_execucao -> finalizado
